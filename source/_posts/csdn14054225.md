---
title: "关于ics lab8 performance中的rotate"
id: csdn14054225
---

首先，你如果发现了写的缓存优化比读的缓存优化效率高，那么恭喜你，你已经迈出了第一步。这个能提升0.2 ~ 0.4左右。

现在来思考一个问题。我们的常规思路就是一次读一整行，也就是src从左至右一次读一列，dst从下至上一次写一行。

![](../img/a4191d3e169320270764804e33fdc48d.png)

但是这样肯定不行，因为你的电脑的缓存没那么大。按照上课老师讲的来看，应该分块。那首先要确定大小，我的测试结果是32最优，可能有些机器上16是最优的。

也就是说 dst还是从左下角开始读，但读完32个之后，不继续往下读了，转而跳到上面那行的起始位置。这时候dst计数器应该减去31再减去dim，src计数器要减去31*dim再加一。

按照这种方式一直写到顶，一共dim次。第一次的时候dst计数器应该在左上角的上一行的位置，也就是-dim的位置；src计数器在第二行第一列，也就是dim的位置（红色的点）。

![](../img/40939c3388072caa0878e993a8cf054a.png)

这时候应该读右边的块了。我们把dst计数器下移dim行左移32列，也就是加上dim*dim再加上32；而src计数器直接下移31行即可，也就是加上31*dim（粉色的点）。外层循环步长为32，内层步长为一，边界条件都是小于dim。